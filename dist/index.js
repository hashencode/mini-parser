const t="area,base,canvas,embed,frame,head,iframe,input,link,map,meta,param,rp,script,source,style,textarea,title,track,wbr".split(","),e="area,base,br,col,circle,ellipse,embed,frame,hr,img,input,line,link,meta,param,path,polygon,rect,source,track,use,wbr".split(","),s="address,article,aside,blockquote,dd,div,dl,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,hr,ol,p,pre,section,table,ul".split(","),n={img:"image",video:"video",a:"link"},i=/^<([-A-Za-z0-9_]+)((?:\s+[a-zA-Z_:][-a-zA-Z0-9_:.]*(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,r=/^<\/([-A-Za-z0-9_]+)[^>]*>/,o=/^<([-A-Za-z0-9_]+)((?:\s+[a-zA-Z_:][-a-zA-Z0-9_:.]*(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/)>/,a=/([a-zA-Z_:][-a-zA-Z0-9_:.]*)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g,l=[[/<\?xml.*\?>\n/,""],[/<.*!doctype.*\>\n/,""],[/<.*!DOCTYPE.*\>\n/,""],[/<!--.*?-->/gi,""],[/\/\*.*?\*\//gi,""]],c={lt:"<",gt:">",quot:'"',apos:"'",ensp:" ",emsp:" ",nbsp:" ",semi:";",ndash:"–",mdash:"—",middot:"·",lsquo:"‘",rsquo:"’",ldquo:"“",rdquo:"”",bull:"•",hellip:"…"};class u{config;constructor(t,e){return this.config=e||{},t?this.steps(t):""}steps(t){const e=this.cleanHtml(t),s=this.decodeHtml(e,!1),n=this.htmlToJson(s);return this.jsonToSkeleton(n)}cleanHtml(t){return t?(l.forEach((e=>{const[s,n]=e;t=t.replace(s,n)})),t):""}decodeHtml(t,e){if(!t)return"";let s=t.indexOf("&");for(;-1!==s;){const n=t.indexOf(";",s+3);let i;if(-1===n)break;"#"===t[s+1]?(i=parseInt(("x"===t[s+2]?"0":"")+t.substring(s+2,n)),isNaN(i)||(t=t.substr(0,s)+String.fromCharCode(i)+t.substr(n+1))):(i=t.substring(s+1,n),(c[i]||"amp"===i&&e)&&(t=t.substr(0,s)+(c[i]||"&")+t.substr(n+1))),s=t.indexOf("&",s+1)}return t}isInvalidElement(e){const{ignoredElement:s=t}=this.config;return s.includes(e)}isSelfClosingElement(t,s){return o.test(t)||e.includes(s)}formatElementName(t){const{transMap:e=n}=this.config;return t in e?e[t]:"view"}attributeProcessor(t,e){const{format:s={}}=this.config;if(s[e]){const n=s[e];Object.keys(n).forEach((e=>{const s=n[e];t[e]="function"==typeof s?s(t[e],t):s}))}return t}formatAttributes(t,e){if(!t)return{};let s={};return t.replace(a,(function(t,e,n){const i=Array.prototype.slice.call(arguments);return i.length>=3&&(s[e]=n?n.replace(/(^|[^\\])"/g,'$1\\"'):""),""})),this.attributeProcessor(s,e)}updateHtmlStr(t,e){return t.substring(e.length)}htmlToJson(t){const n=[];for(;t;){if(0===t.indexOf("</")){const s=t.match(r);if(!s)continue;const[i,o]=s,a=this.updateHtmlStr(t,i);if(this.isInvalidElement(o)){t=a;continue}t=a;const l=e.includes(o);n.push({type:l?"selfClosing":"end",name:this.formatElementName(o),originName:o});continue}if(0===t.indexOf("<")){const e=t.match(i);if(!e)continue;const[r,o,a=""]=e,l=this.updateHtmlStr(t,r);if(this.isInvalidElement(o)){t=l;continue}t=l;const c=this.isSelfClosingElement(r,o),u=this.formatAttributes(a,o);let h=s.includes(o)?"block":"inline";n.push({type:c?"selfClosing":"start",name:this.formatElementName(o),originName:o,attrs:u,display:h});continue}const o=t.indexOf("<"),a=o<0;let l=a?t:t.substring(0,o);t=a?"":t.substring(o),n.push({type:"text",name:"text",originName:"text",attrs:this.attributeProcessor({content:l},"text")})}return n}skeletonGenerator(t,e=0){if(t.length<=0)return[];let s=0;const n=[];for(;s<t.length;){const{genKey:i,type:r,...o}=t[s],a=`${e}_${s}_${o.name}`,l=["start","end"].includes(r)?"default":r;if("start"===r){const e=t.findIndex((({type:t,genKey:e})=>"end"===t&&e==e));if(-1===e)break;n.push({id:a,...o,type:l,children:this.skeletonGenerator(t.slice(s+1,e),s)}),s=e+1}else n.push({id:a,...o,type:l}),s++}return n}jsonToSkeleton(t){const e=[];return t.forEach(((t,s)=>{const{type:n}=t;switch(n){case"start":t.genKey=s,e.push(s);break;case"end":const n=e.splice(e.length-1,1)[0];t.genKey=n}})),this.skeletonGenerator(t)}}export{u as MiniParser,t as defaultIgnoreElements,n as defaultTransMap};
